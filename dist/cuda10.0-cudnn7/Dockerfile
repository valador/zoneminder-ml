# Code generated by gomplate; DO NOT EDIT.
# This file generated by gomplate at
# Fri, 04 Dec 2020 15:39:47 UTC
# using data from cuda10.0-cudnn7.yaml

FROM nvidia/cuda:10.0-cudnn7-devel-ubuntu16.04 AS ffmpeg-build

ENV \
    DEBIAN_FRONTEND="noninteractive" \
    FFMPEG_VERSION="4.3" \
    KVAZAAR_VERSION="1.3.0" \
    FFMPEG_PATH="/ffmpeg"
ENV \
    LD_LIBRARY_PATH="${FFMPEG_PATH}/lib:${LD_LIBRARY_PATH}" \
    PKG_CONFIG_PATH="${FFMPEG_PATH}/lib/pkgconfig:${PKG_CONFIG_PATH}"

RUN \
    # Add ffmpeg ppa https://launchpad.net/~jonathonf/+archive/ubuntu/ffmpeg-4
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys "F06FC659" && \
    export $(cat /etc/os-release | grep UBUNTU_CODENAME) && \
    echo "deb http://ppa.launchpad.net/jonathonf/ffmpeg-4/ubuntu ${UBUNTU_CODENAME} main" > \
      /etc/apt/sources.list.d/ffmpeg.list && \
    echo "deb-src http://ppa.launchpad.net/jonathonf/ffmpeg-4/ubuntu ${UBUNTU_CODENAME} main" >> \
      /etc/apt/sources.list.d/ffmpeg.list && \
    apt-get update && \
    # Install ffmpeg build dependencies
    deps="\
      autoconf \
      automake \
      build-essential \
      ca-certificates \
      ccache \
      cmake \
      frei0r-plugins-dev \
      git-core \
      ladspa-sdk \
      libaom-dev \
      libaribb24-dev \
      libass-dev \
      libbluray-dev \
      libcaca-dev \
      libcdio-paranoia-dev \
      libchromaprint-dev \
      libcodec2-dev \
      libdrm-dev \
      libfdk-aac-dev \
      libfontconfig1-dev \
      libfreetype6-dev \
      libfribidi-dev \
      libgme-dev \
      libgmp-dev \
      libgomp1 \
      libgsm1-dev \
      libjack-dev \
      libleptonica-dev \
      liblilv-dev \
      libmodplug-dev \
      libmp3lame-dev \
      libmysofa-dev \
      libnorm-dev \
      libogg-dev \
      libopenal-dev \
      libopencore-amrnb-dev \
      libopencore-amrwb-dev \
      libopenjp2-7-dev \
      libopenmpt-dev \
      libopus-dev \
      libpthread-stubs0-dev \
      libpulse-dev \
      librsvg2-dev \
      librtmp-dev \
      librubberband-dev \
      libsdl2-dev \
      libshine-dev \
      libsmbclient-dev \
      libsnappy-dev \
      libsoxr-dev \
      libspeex-dev \
      libsrt-gnutls-dev \
      libssh-dev \
      libssl-dev \
      libtesseract-dev \
      libtheora-dev \
      libtool \
      libtwolame-dev \
      libv4l-dev \
      libva-dev \
      libvdpau-dev \
      libvidstab-dev \
      libvo-amrwbenc-dev \
      libvorbis-dev \
      libvpx-dev \
      libwavpack-dev \
      libwebp-dev \
      libx264-dev \
      libx265-dev \
      libxau-dev \
      libxcb-shm0-dev \
      libxcb-xfixes0-dev \
      libxcb1-dev \
      libxml2-dev \
      libxvidcore-dev \
      libzimg-dev \
      libzmq3-dev \
      libzvbi-dev \
      m4 \
      nasm \
      pkg-config \
      texinfo \
      wget \
      yasm \
      zlib1g-dev \
      libffmpeg-nvenc-dev \
      nvidia-opencl-dev \
      " && \
    apt-get install -y --no-install-recommends ${deps} && \
    # Build kvazaar https://github.com/ultravideo/kvazaar
    mkdir -p /tmp/kvazaar && \
    cd /tmp/kvazaar && \
    git clone -b "v${KVAZAAR_VERSION}" --depth 1 \
      "https://github.com/ultravideo/kvazaar.git" . && \
    ./autogen.sh && \
    ./configure \
      --enable-shared \
      --prefix=${FFMPEG_PATH} \
    && \
    make -j$(nproc) && \
    make install && \
    # Build ffmpeg https://ffmpeg.org
    mkdir -p /tmp/ffmpeg && \
    cd /tmp/ffmpeg && \
    wget "https://ffmpeg.org/releases/ffmpeg-${FFMPEG_VERSION}.tar.gz" && \
    tar -xz --strip-components=1 -f ffmpeg-${FFMPEG_VERSION}.tar.gz && \
    ./configure \
      --disable-debug \
      --disable-doc \
      --enable-avresample \
      --enable-chromaprint \
      --enable-fontconfig \
      --enable-frei0r \
      --enable-gmp \
      --enable-gpl \
      --enable-ladspa \
      --enable-libaom \
      --enable-libaribb24 \
      --enable-libass \
      --enable-libbluray \
      --enable-libcaca \
      --enable-libcdio \
      --enable-libcodec2 \
      --enable-libdrm \
      --enable-libfdk_aac \
      --enable-libfontconfig \
      --enable-libfreetype \
      --enable-libfribidi \
      --enable-libgme \
      --enable-libgsm \
      --enable-libjack \
      --enable-libkvazaar \
      --enable-libmodplug \
      --enable-libmp3lame \
      --enable-libmysofa \
      --enable-libnpp \
      --enable-libopencore-amrnb \
      --enable-libopencore-amrwb \
      --enable-libopenjpeg \
      --enable-libopenmpt \
      --enable-libopus \
      --enable-libpulse \
      --enable-librsvg \
      --enable-librtmp \
      --enable-librubberband \
      --enable-libshine \
      --enable-libsnappy \
      --enable-libsoxr \
      --enable-libspeex \
      --enable-libsrt \
      --enable-libssh \
      --enable-libtesseract \
      --enable-libtheora \
      --enable-libtwolame \
      --enable-libv4l2 \
      --enable-libvidstab \
      --enable-libvo-amrwbenc \
      --enable-libvorbis \
      --enable-libvpx \
      --enable-libwavpack \
      --enable-libwebp \
      --enable-libx264 \
      --enable-libx265 \
      --enable-libxcb \
      --enable-libxml2 \
      --enable-libxvid \
      --enable-libzimg \
      --enable-libzmq \
      --enable-libzvbi \
      --enable-lv2 \
      --enable-nonfree \
      --enable-openal \
      --enable-opencl \
      --enable-opengl \
      --enable-openssl \
      --enable-postproc \
      --enable-shared \
      --enable-small \
      --enable-version3 \
      --extra-libs="-lpthread -ldl -lm" \
      --prefix=${FFMPEG_PATH} \
      --enable-cuda \
      --enable-cuda-nvcc \
      --enable-cuvid \
      --enable-nvenc \
      --extra-cflags="-I/usr/local/cuda/include" \
      --extra-ldflags="-L/usr/local/cuda/lib64" \
      && \
    make -j$(nproc) && \
    make install && \
    # Cleanup
    apt-get remove -y ${deps} && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    truncate -s 0 /var/log/*log

FROM nvidia/cuda:10.0-cudnn7-runtime-ubuntu16.04

ARG zm_version
ARG DEBIAN_FRONTEND="noninteractive"

ENV \
    ZM_VERSION="${zm_version}" \
    PHP_VERSION="7.4" \
    FFMPEG_VERSION="4.3" \
    NVIDIA_DRIVER_CAPABILITIES="compute,utility,video" \
    TZ="Etc/UTC"

# Copy ffmpeg files
COPY --from=ffmpeg-build /ffmpeg/ /usr/local/

RUN \
    # Add ffmpeg ppa https://launchpad.net/~jonathonf/+archive/ubuntu/ffmpeg-4
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys "F06FC659" && \
    export $(cat /etc/os-release | grep UBUNTU_CODENAME) && \
    echo "deb http://ppa.launchpad.net/jonathonf/ffmpeg-4/ubuntu ${UBUNTU_CODENAME} main" > \
      /etc/apt/sources.list.d/ffmpeg.list && \
    echo "deb-src http://ppa.launchpad.net/jonathonf/ffmpeg-4/ubuntu ${UBUNTU_CODENAME} main" >> \
      /etc/apt/sources.list.d/ffmpeg.list && \
    apt-get update && \
    # Add php ppa https://launchpad.net/~ondrej/+archive/ubuntu/php
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys "E5267A6C" && \
    export $(cat /etc/os-release | grep UBUNTU_CODENAME) && \
    echo "deb http://ppa.launchpad.net/ondrej/php/ubuntu ${UBUNTU_CODENAME} main" > \
      /etc/apt/sources.list.d/php.list && \
    echo "deb-src http://ppa.launchpad.net/ondrej/php/ubuntu ${UBUNTU_CODENAME} main" >> \
      /etc/apt/sources.list.d/php.list && \
    apt-get update && \
    # Install dependencies
    apt-get install -y --no-install-recommends \
      # ffmpeg dependencies
      libaom0 \
      libaribb24-0 \
      libass5 \
      libbluray1 \
      libcaca0 \
      libcdio-paranoia1 \
      libchromaprint1 \
      libcodec2-0.4 \
      libdrm2 \
      libfdk-aac2 \
      libfontconfig1 \
      libfreetype6 \
      libfribidi0 \
      libgme0 \
      libgmp10 \
      libgsm1 \
      libjack0 \
      liblilv-0-0 \
      libmodplug1 \
      libmp3lame0 \
      libmysofa1 \
      libnorm1 \
      libogg0 \
      libopenal1 \
      libopencore-amrnb0 \
      libopencore-amrwb0 \
      libopenjp2-7 \
      libopenmpt0 \
      libopus0 \
      libpulse0 \
      librsvg2-2 \
      librtmp1 \
      librubberband2v5 \
      libsdl2-2.0-0 \
      libshine-dev \
      libsmbclient \
      libsnappy1v5 \
      libsoxr0 \
      libspeex1 \
      libsrt1-gnutls \
      libssh-4 \
      libssl1.0.0 \
      libtesseract3 \
      libtheora0 \
      libtwolame0 \
      libv4l-0 \
      libva1 \
      libvdpau1 \
      libvidstab1.1 \
      libvo-amrwbenc0 \
      libvorbis0a \
      libvpx3 \
      libwavpack1 \
      libwebp5 \
      libx264-155 \
      libx265-192 \
      libxau6 \
      libxcb-shape0 \
      libxcb-shm0 \
      libxcb-xfixes0 \
      libxcb1 \
      libxml2 \
      libxv1 \
      libxvidcore4 \
      libzimg2 \
      libzmq5 \
      libzvbi0 \
      zlib1g \
      # zoneminder dependencies
      apache2 \
      ca-certificates \
      libapache2-mod-php${PHP_VERSION} \
      net-tools \
      php${PHP_VERSION} \
      php${PHP_VERSION}-fpm \
      php${PHP_VERSION}-gd \
      php${PHP_VERSION}-mysql \
      sudo \
      supervisor \
    && \
    # Add zoneminder ppa repository https://launchpad.net/~iconnor/+archive/ubuntu/zoneminder-1.34
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys "776FFB04" && \
    export $(cat /etc/os-release | grep UBUNTU_CODENAME) && \
    echo "deb http://ppa.launchpad.net/iconnor/zoneminder-${ZM_VERSION}/ubuntu ${UBUNTU_CODENAME} main" > \
    /etc/apt/sources.list.d/zoneminder-${ZM_VERSION}.list && \
    echo "deb-src http://ppa.launchpad.net/iconnor/zoneminder-${ZM_VERSION}/ubuntu ${UBUNTU_CODENAME} main" >> \
    /etc/apt/sources.list.d/zoneminder-${ZM_VERSION}.list && \
    apt-get update && \
    # Install zoneminder https://github.com/ZoneMinder/zoneminder
    apt-get install -y --no-install-recommends zoneminder && \
    mkdir -p /var/cache/zoneminder /var/log/zm && \
    # Configure apache2 (httpd)
    a2enmod php${PHP_VERSION} cgi expires headers rewrite && \
    a2enconf php${PHP_VERSION}-fpm zoneminder && \
    echo 'ServerName "localhost"' >> /etc/apache2/apache2.conf && \
    mkdir -p /var/run/apache2 && \
    rm -f /var/log/apache2/* && \
    ln -s /dev/stdout /var/log/apache2/access.log && \
    ln -s /dev/stdout /var/log/apache2/other_vhosts_access.log && \
    ln -s /dev/stderr /var/log/apache2/error.log && \
    # Cleanup
    apt-get remove -y software-properties-common && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    truncate -s 0 /var/log/*log

COPY ./supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY ./zm.conf /etc/zm/conf.d/10-zm.conf
COPY ./zm.sh /usr/sbin/zm.sh
COPY ./entrypoint.sh /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/usr/bin/supervisord"]

VOLUME [ "/var/cache/zoneminder", "/var/log/zm" ]
EXPOSE 80
{{- with (ds "platform") -}}
# Code generated by gomplate; DO NOT EDIT.
# This file generated by gomplate at
# {{ (time.Now).UTC.Format time.RFC1123 }}
# using data from {{ .name }}.yaml

{{ tmpl.Exec "ffmpeg" . }}

FROM {{ .image }}

ARG zm_version
ARG DEBIAN_FRONTEND="noninteractive"

ENV \
    ZM_VERSION="${zm_version}" \
    PHP_VERSION="{{ .php_version }}" \
    FFMPEG_VERSION="{{ .ffmpeg.version }}" \
    NVIDIA_DRIVER_CAPABILITIES="compute,utility,video" \
    TZ="Etc/UTC"

# Copy ffmpeg files
COPY --from=ffmpeg-build /ffmpeg/ /usr/local/

RUN \
{{ tmpl.Exec "ffmpeg/ppa" | indent 4 }}
{{ tmpl.Exec "php/ppa" | indent 4 }}
    # Install dependencies
    apt-get install -y --no-install-recommends \
{{ tmpl.Exec "ffmpeg/deps" . | indent 6 }}
      # zoneminder dependencies
      apache2 \
      ca-certificates \
      libapache2-mod-php${PHP_VERSION} \
      net-tools \
      php${PHP_VERSION} \
      php${PHP_VERSION}-fpm \
      php${PHP_VERSION}-gd \
      php${PHP_VERSION}-mysql \
      sudo \
      supervisor \
    && \
    # Add zoneminder ppa repository https://launchpad.net/~iconnor/+archive/ubuntu/zoneminder-1.34
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys "776FFB04" && \
    export $(cat /etc/os-release | grep UBUNTU_CODENAME) && \
    echo "deb http://ppa.launchpad.net/iconnor/zoneminder-${ZM_VERSION}/ubuntu ${UBUNTU_CODENAME} main" > \
    /etc/apt/sources.list.d/zoneminder-${ZM_VERSION}.list && \
    echo "deb-src http://ppa.launchpad.net/iconnor/zoneminder-${ZM_VERSION}/ubuntu ${UBUNTU_CODENAME} main" >> \
    /etc/apt/sources.list.d/zoneminder-${ZM_VERSION}.list && \
    apt-get update && \
    # Install zoneminder https://github.com/ZoneMinder/zoneminder
    apt-get install -y --no-install-recommends zoneminder && \
    mkdir -p /var/cache/zoneminder /var/log/zm && \
    # Configure apache2 (httpd)
    a2enmod php${PHP_VERSION} cgi expires headers rewrite && \
    a2enconf php${PHP_VERSION}-fpm zoneminder && \
    echo 'ServerName "localhost"' >> /etc/apache2/apache2.conf && \
    mkdir -p /var/run/apache2 && \
    rm -f /var/log/apache2/* && \
    ln -s /dev/stdout /var/log/apache2/access.log && \
    ln -s /dev/stdout /var/log/apache2/other_vhosts_access.log && \
    ln -s /dev/stderr /var/log/apache2/error.log && \
    # Cleanup
    apt-get remove -y software-properties-common && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    truncate -s 0 /var/log/*log

COPY ./supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY ./zm.conf /etc/zm/conf.d/10-zm.conf
COPY ./zm.sh /usr/sbin/zm.sh
COPY ./entrypoint.sh /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/usr/bin/supervisord"]

VOLUME [ "/var/cache/zoneminder", "/var/log/zm" ]
EXPOSE 80
{{- end -}}
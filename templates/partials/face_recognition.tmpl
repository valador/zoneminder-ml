FROM {{ .build_image }} AS face_recognition-build

ENV \
    DEBIAN_FRONTEND="noninteractive" \
    FACE_RECOGNITION_VERSION="{{ .face_recognition.version }}" \
    PYTHON_VERSION="{{ .python_version }}" \
    FACE_RECOGNITION_PATH="/face_recognition"

RUN \
{{ tmpl.Exec "python/install" | indent 4 }}
    # Install face_recognition build dependencies
    deps="\
      build-essential \
      ccache \
      cmake \
      libblas-dev \
      libgif-dev \
      libjpeg-dev \
      liblapack-dev \
      liblapacke-dev \
      libopenblas-dev \
      libpng-dev \
      python${PYTHON_VERSION}-dev \
    " && \
    apt-get install -y --no-install-recommends ${deps} && \
    # Build face_recognition https://github.com/ageitgey/face_recognition
    mkdir -p /tmp/face_recognition && \
    python3 -m pip install --no-cache-dir --root /tmp/face_recognition -v \
      numpy \
      mkl_fft \
      face_recognition==${FACE_RECOGNITION_VERSION} \
    && \
    mv /tmp/face_recognition/usr/local ${FACE_RECOGNITION_PATH} && \
    # Cleanup
{{ tmpl.Exec "python/remove" | indent 4 }}
    apt-get remove -y ${deps} && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    truncate -s 0 /var/log/*log